root_project: pvt.lzwdgc.polygon4.data_manager

common_settings:
    c++: 17

add_directories:
    - d:/dev/primitives

projects:
    data_manager:
        type: lib
        api_name: DATA_MANAGER_API
        files:
            - include/.*
            - src/manager/.*\.h
            - src/manager/.*\.cpp
            - data/schema.txt
        include_directories:
            public:
                - include
            private:
                - src/manager
        dependencies:
            - name: generator
              reference: generator
            - schema
            - memory
            - pvt.cppan.demo.boost.log: 1
            - pvt.cppan.demo.sqlite3: 3

        options:
            any:
                compile_options:
                    msvc:
                        public:
                            - "/wd4251"
                            - "/wd4275"

        post_sources: |
            set(tail)
            if (MSVC)
                #set(tail _$(Configuration))
            endif()

            set(generated_dir ${BDIR}/gen${tail})
            set(generated_dir_inc           ${generated_dir}/include)
            set(generated_dir_inc_detail    ${generated_dir}/include/detail)
            set(generated_dir_src           ${generated_dir}/src)
            set(generated_dir_src_detail    ${generated_dir}/src/detail)

            execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${generated_dir_inc})
            execute_process(COMMAND ${CMAKE_COMMAND} -E make_directory ${generated_dir_src})

            set(generated_src
                ${generated_dir_inc_detail}/ForwardDeclarations.h
                ${generated_dir_inc_detail}/Types.h
                ${generated_dir_src_detail}/Types.cpp
                ${generated_dir_inc_detail}/Storage.h
                ${generated_dir_src_detail}/Storage.cpp
                ${generated_dir_inc_detail}/StorageImpl.h
                ${generated_dir_src_detail}/StorageImpl.cpp
                ${generated_dir_src_detail}/schema/Tokens.cpp
                ${generated_dir_inc_detail}/ObjectInterfaces.h
                ${generated_dir_inc_detail}/Enums.h
                ${generated_dir_src_detail}/Enums.cpp
            )
            add_custom_command(OUTPUT ${generated_src}
                COMMAND ${generator} ${SDIR}/data/schema.txt ${generated_dir}
                DEPENDS ${generator} ${SDIR}/data/schema.txt
                COMMENT "Generating data files"
            )
            set_source_files_properties(${generated_src} PROPERTIES
                HEADER_FILE_ONLY True
            )
            set(src ${src} ${generated_src})
        post_target: |
            target_include_directories(${this}
                PUBLIC ${generated_dir_inc}
                PRIVATE ${generated_dir_src}
            )
            if (MSVC)
                target_compile_options(${this} PUBLIC /bigobj)
            endif()

    generator:
        files: src/generator/main.cpp
        dependencies:
            - schema
            - memory
            - name: pvt.egorpugin.primitives.sw.main
              version: master
              local: primitives.sw.main

    schema:
        type: lib
        api_name: SCHEMA_API
        files:
            - include/.*
            - src/schema/.*\.h
            - src/schema/.*\.cpp
            - src/schema/.*\.ll
            - src/schema/.*\.yy
        include_directories:
            public:
                - include
            private:
                - include/Polygon4/DataManager/Schema
                - src/schema
        options:
            any:
                compile_options:
                    msvc:
                        public:
                            - "/wd4251"
        dependencies:
            - memory
            - pvt.cppan.demo.boost.algorithm: 1
            - pvt.cppan.demo.boost.variant: 1
            - name: pvt.egorpugin.primitives.templates
              version: master
              local: primitives.templates
            - name: pvt.egorpugin.primitives.context
              version: master
              local: primitives.context
            - name: pvt.egorpugin.primitives.filesystem
              version: master
              local: primitives.filesystem
            - name: pvt.cppan.demo.lexxmark.winflexbison.flex
              version: master
              ref: flex
              condition:
                  - WIN32
            - name: pvt.cppan.demo.lexxmark.winflexbison.bison
              version: master
              ref: bison
              condition:
                  - WIN32

        post_sources: |
            cppan_flex_bison_pair(LALR1_CPP_VARIANT_PARSER src/schema/schema)

    memory:
        type: lib
        static_only: true
        files:
            - include/Polygon4/Memory.h
            - src/memory/Memory.cpp

